name: Color swap, build and deploy to gh-pages

on:
  workflow_dispatch:
    inputs:
      color_from:
        description: 'Hex color to replace (include #)'
        required: true
        default: '#eb99a1'
      color_to:
        description: 'Hex replacement color (include #)'
        required: true
        default: '#4E35F2'
      base_href:
        description: 'Base href to use when building (pass-through value)'
        required: true
        default: 'https://stacker-dao.github.io/astrodrop/'
      build_command:
        description: 'Shell command used to build the project'
        required: true
        default: 'npm install --legacy-peer-deps graphql@15.8.0 && npx ng build --configuration production --base-href "$BASE_HREF"'
      publish_dir:
        description: 'Directory containing build output to publish'
        required: true
        default: 'dist/merkle-drop'
      pages_branch:
        description: 'Branch to push built assets to (GitHub Pages branch)'
        required: true
        default: 'gh-pages'
      commit_source_changes:
        description: 'If "true", commit color replacements back to the current branch'
        required: true
        default: 'true'

jobs:
  replace-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js (Node 14 for Angular 10/11 compatibility)
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Resolve inputs (debug)
        shell: bash
        run: |
          # Use GitHub inputs with fallbacks to sensible defaults for robustness
          COLOR_FROM="${{ github.event.inputs.color_from || '#eb99a1' }}"
          COLOR_TO="${{ github.event.inputs.color_to || '#4E35F2' }}"
          BASE_HREF="${{ github.event.inputs.base_href || 'https://stacker-dao.github.io/astrodrop/' }}"
          BUILD_COMMAND="${{ github.event.inputs.build_command || 'npm install --legacy-peer-deps graphql@15.8.0 && npx ng build --configuration production --base-href \"$BASE_HREF\"' }}"
          PUBLISH_DIR="${{ github.event.inputs.publish_dir || 'dist/merkle-drop' }}"
          PAGES_BRANCH="${{ github.event.inputs.pages_branch || 'gh-pages' }}"
          COMMIT_SOURCE_CHANGES="${{ github.event.inputs.commit_source_changes || 'true' }}"
          echo "Inputs resolved:"
          echo "  COLOR_FROM=${COLOR_FROM}"
          echo "  COLOR_TO=${COLOR_TO}"
          echo "  BASE_HREF=${BASE_HREF}"
          echo "  BUILD_COMMAND=${BUILD_COMMAND}"
          echo "  PUBLISH_DIR=${PUBLISH_DIR}"
          echo "  PAGES_BRANCH=${PAGES_BRANCH}"
          echo "  COMMIT_SOURCE_CHANGES=${COMMIT_SOURCE_CHANGES}"

      - name: Replace color across repository (case-insensitive)
        shell: bash
        run: |
          set -eo pipefail
          COLOR_FROM="${{ github.event.inputs.color_from || '#eb99a1' }}"
          COLOR_TO="${{ github.event.inputs.color_to || '#4E35F2' }}"
          # Search only tracked files to avoid touching build artifacts or node_modules
          FILES=$(git ls-files '*.css' '*.scss' '*.sass' '*.less' '*.html' '*.htm' '*.ts' '*.tsx' '*.js' '*.jsx' || true)
          if [ -z "$FILES" ]; then
            echo "No candidate files found for replacement; skipping."
            exit 0
          fi
          echo "Replacing ${COLOR_FROM} -> ${COLOR_TO} in the following tracked files:"
          echo "$FILES"
          # perl in-place case-insensitive replacement
          perl -pi -e "s/\Q${COLOR_FROM}\E/${COLOR_TO}/ig" $FILES || true

      - name: Commit and push source color-change (optional)
        if: ${{ github.event.inputs.commit_source_changes == 'true' || github.event.inputs.commit_source_changes == '' }}
        shell: bash
        run: |
          set -eo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "chore: replace color ${COLOR_FROM} â†’ ${COLOR_TO} (automated)"
            git push origin HEAD
          else
            echo "No source changes to commit."
          fi

      - name: Build project (install deps including graphql then build)
        shell: bash
        env:
          BASE_HREF: "${{ github.event.inputs.base_href || 'https://stacker-dao.github.io/astrodrop/' }}"
          PUBLIC_URL: "${{ github.event.inputs.base_href || 'https://stacker-dao.github.io/astrodrop/' }}"
          VITE_BASE: "${{ github.event.inputs.base_href || 'https://stacker-dao.github.io/astrodrop/' }}"
        run: |
          set -eo pipefail
          # Allow overriding build command through workflow inputs if needed
          BUILD_CMD="${{ github.event.inputs.build_command || 'npm install --legacy-peer-deps graphql@15.8.0 && npx ng build --configuration production --base-href \"$BASE_HREF\"' }}"
          echo "Running build command:"
          echo "${BUILD_CMD}"
          bash -lc "${BUILD_CMD}"

      - name: Deploy to GitHub Pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.event.inputs.publish_dir || 'dist/merkle-drop' }}
          publish_branch: ${{ github.event.inputs.pages_branch || 'gh-pages' }}
          keep_files: false
