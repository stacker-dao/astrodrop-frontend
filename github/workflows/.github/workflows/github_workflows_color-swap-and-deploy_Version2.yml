name: Color swap, build and deploy to gh-pages

on:
  workflow_dispatch:
    inputs:
      color_from:
        description: 'Hex color to replace (include #)'
        required: true
        default: '#eb99a1'
      color_to:
        description: 'Hex replacement color (include #)'
        required: true
        default: '#4E35F2'
      base_href:
        description: 'Base href to use when building (pass-through value)'
        required: true
        default: 'https://stacker-dao.github.io/astrodrop/'
      build_command:
        description: 'Shell command used to build the project'
        required: true
        default: 'npm ci && npx ng build --configuration production --base-href "$BASE_HREF"'
      publish_dir:
        description: 'Directory containing build output to publish'
        required: true
        default: 'dist/merkle-drop'
      pages_branch:
        description: 'Branch to push built assets to (GitHub Pages branch)'
        required: true
        default: 'gh-pages'
      commit_source_changes:
        description: 'If "true", commit color replacements back to the current branch'
        required: true
        default: 'true'

jobs:
  replace-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Replace color across repository (case-insensitive)
        run: |
          set -euo pipefail
          COLOR_FROM="${{ github.event.inputs.color_from }}"
          COLOR_TO="${{ github.event.inputs.color_to }}"
          FILES=$(git ls-files '*.css' '*.scss' '*.sass' '*.less' '*.html' '*.htm' '*.ts' '*.tsx' '*.js' '*.jsx' || true)
          if [ -z "$FILES" ]; then
            echo "No candidate files found for replacement; skipping."
            exit 0
          fi
          echo "Replacing ${COLOR_FROM} -> ${COLOR_TO} in the following tracked files:"
          echo "$FILES"
          perl -pi -e "s/\Q${COLOR_FROM}\E/${COLOR_TO}/ig" $FILES || true

      - name: Commit and push source color-change (optional)
        if: ${{ github.event.inputs.commit_source_changes == 'true' }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "chore: replace color ${COLOR_FROM} â†’ ${COLOR_TO} (automated)"
            git push origin HEAD
          else
            echo "No source changes to commit."
          fi

      - name: Build project
        env:
          BASE_HREF: "${{ github.event.inputs.base_href }}"
          PUBLIC_URL: "${{ github.event.inputs.base_href }}"
          VITE_BASE: "${{ github.event.inputs.base_href }}"
        run: |
          set -euo pipefail
          echo "Running build command (as provided):"
          echo "${{ github.event.inputs.build_command }}"
          bash -lc "${{ github.event.inputs.build_command }}"

      - name: Deploy to GitHub Pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.event.inputs.publish_dir }}
          publish_branch: ${{ github.event.inputs.pages_branch }}
          keep_files: false
